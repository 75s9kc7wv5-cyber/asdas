<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sim of World - Parti Paneli</title>
    <link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.css">
    
    <style>
        :root {
            --bg-dark: #0a0a0a; 
            --bg-card: #141414; 
            --bg-input: #1a1a1a;
            --accent: #9b59b6; /* Siyaset Teması: Mor */
            --accent-cyan: #00e5ff; 
            --accent-gold: #ffd700; 
            --accent-red: #e74c3c;
            --accent-green: #2ecc71;
            --text-white: #ffffff; 
            --text-muted: #888; 
            --border-color: #222;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            background-color: #000;
            font-family: 'Rajdhani', sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            color: var(--text-white);
        }

        .game-container {
            width: 100%; max-width: 450px; background-color: var(--bg-dark);
            height: 100vh; display: flex; flex-direction: column; position: relative;
            box-shadow: 0 0 40px rgba(0,0,0,0.5); border-left: 1px solid #111; border-right: 1px solid #111;
        }

        /* HEADER */
        header { background-color: rgba(10,10,10,0.9); backdrop-filter: blur(10px); padding: 10px; border-bottom: 1px solid var(--border-color); }
        .top-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .logo { font-size: 1.2rem; font-weight: 700; }
        .stat-box { background: var(--bg-input); padding: 5px 10px; border-radius: 4px; font-size: 0.9rem; color: var(--accent-cyan); display: flex; align-items: center; gap: 5px; }
        .status-bars { display: flex; gap: 5px; }
        .bar-item { background: var(--bg-input); padding: 4px; border-radius: 15px; font-size: 0.75rem; flex: 1; text-align: center; font-weight: bold; }

        /* MAIN */
        main { flex: 1; padding: 20px; overflow-y: auto; padding-bottom: 80px; }

        /* HERO SECTION (Parti Özeti) */
        .party-hero {
            background: linear-gradient(135deg, rgba(155, 89, 182, 0.15), var(--bg-card));
            border: 1px solid var(--accent); border-radius: 16px;
            padding: 20px; margin-bottom: 20px; position: relative;
            text-align: center; overflow: hidden;
            box-shadow: 0 0 20px rgba(155, 89, 182, 0.1);
        }
        .party-logo-lg {
            width: 80px; height: 80px; background: #222; border-radius: 50%; 
            display: flex; align-items: center; justify-content: center; 
            font-size: 2rem; font-weight: 800; color: var(--accent); border: 2px solid var(--accent);
            margin: 0 auto 10px; box-shadow: 0 0 15px rgba(155, 89, 182, 0.3);
        }
        .ph-name { font-size: 1.5rem; font-weight: 800; color: #fff; margin-bottom: 5px; }
        .ph-ideology { font-size: 0.9rem; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 15px; }
        
        .ph-stats { display: flex; justify-content: center; gap: 20px; background: rgba(0,0,0,0.3); padding: 10px; border-radius: 8px; }
        .phs-item { display: flex; flex-direction: column; }
        .phs-val { font-size: 1.1rem; font-weight: bold; color: #fff; }
        .phs-lbl { font-size: 0.7rem; color: #aaa; text-transform: uppercase; }

        /* TABS */
        .tabs { display: flex; gap: 10px; margin-bottom: 20px; background: #111; padding: 5px; border-radius: 8px; border: 1px solid #333; }
        .tab-btn { flex: 1; padding: 10px; border: none; background: transparent; color: #777; font-family: 'Rajdhani'; font-weight: bold; cursor: pointer; border-radius: 6px; transition: all 0.3s; }
        .tab-btn.active { background: #222; color: var(--accent); border: 1px solid var(--accent); box-shadow: 0 0 10px rgba(155, 89, 182, 0.2); }

        /* TAB CONTENT */
        .content-section { animation: fadeIn 0.4s; }

        /* DUYURU PANOSU */
        .notice-board { background: var(--bg-card); border: 1px solid var(--border-color); border-radius: 10px; padding: 15px; margin-bottom: 20px; border-left: 4px solid var(--accent-gold); }
        .nb-title { font-size: 0.9rem; font-weight: bold; color: var(--accent-gold); margin-bottom: 5px; display: flex; align-items: center; gap: 5px; }
        .nb-text { font-size: 0.85rem; color: #ccc; line-height: 1.4; }
        .nb-date { font-size: 0.7rem; color: #666; margin-top: 5px; text-align: right; }

        /* KASA YÖNETİMİ */
        .treasury-card {
            background: linear-gradient(135deg, rgba(46, 204, 113, 0.1), var(--bg-card));
            border: 1px solid var(--accent-green); border-radius: 10px; padding: 15px; margin-bottom: 20px; text-align: center;
        }
        .tr-val { font-size: 2rem; font-weight: 800; color: var(--accent-green); margin: 10px 0; text-shadow: 0 0 10px rgba(46, 204, 113, 0.2); }
        .tr-action { display: flex; gap: 10px; margin-top: 10px; }
        
        .modern-input { width: 100%; background: #000; border: 1px solid #444; color: #fff; padding: 10px; border-radius: 5px; font-family: 'Rajdhani'; outline: none; text-align: center; }
        .btn-donate { width: 100%; padding: 10px; background: var(--accent-green); color: #000; border: none; border-radius: 5px; font-weight: bold; cursor: pointer; font-family: 'Rajdhani'; }

        /* ÜYE LİSTESİ */
        .member-list { display: flex; flex-direction: column; gap: 10px; }
        .member-card {
            background: var(--bg-card); border: 1px solid var(--border-color); border-radius: 8px; padding: 10px;
            display: flex; align-items: center; justify-content: space-between;
        }
        .mc-left { display: flex; align-items: center; gap: 10px; flex: 1; }
        .mc-avatar { width: 35px; height: 35px; border-radius: 50%; background: #333; border: 1px solid #555; }
        .mc-name { font-size: 0.95rem; font-weight: 700; color: #fff; }
        .mc-role { font-size: 0.7rem; padding: 2px 6px; border-radius: 4px; background: #222; color: #aaa; text-transform: uppercase; }
        .role-leader { color: var(--accent-gold); border: 1px solid var(--accent-gold); background: rgba(255, 215, 0, 0.1); }
        .role-vice { color: var(--accent-cyan); border: 1px solid var(--accent-cyan); background: rgba(0, 229, 255, 0.1); }
        .role-org { color: var(--accent-green); border: 1px solid var(--accent-green); background: rgba(46, 204, 113, 0.1); }
        .role-member { color: #aaa; border: 1px solid #444; background: #222; }

        .btn-kick { background: transparent; border: 1px solid var(--accent-red); color: var(--accent-red); padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 0.75rem; font-weight: bold; }
        .btn-kick:hover { background: var(--accent-red); color: #fff; }

        /* AYARLAR BUTONU */
        .btn-leave { 
            width: 100%; padding: 12px; margin-top: 20px; border: 1px solid var(--accent-red); background: rgba(231, 76, 60, 0.1);
            color: var(--accent-red); font-weight: bold; border-radius: 8px; cursor: pointer; font-family: 'Rajdhani'; 
        }

        /* BOTTOM NAV */
        .bottom-nav { position: absolute; bottom: 0; width: 100%; background: #0a0a0a; border-top: 1px solid #333; display: flex; justify-content: space-around; padding: 10px 0; z-index: 10; }
        .nav-item { display: flex; flex-direction: column; align-items: center; color: var(--text-muted); font-size: 0.75rem; cursor: pointer; }
        .nav-item i { font-size: 1.4rem; margin-bottom: 3px; }
        .nav-item.active { color: var(--accent); }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes fadeInDown { from { opacity: 0; transform: translateY(-20px); } to { opacity: 1; transform: translateY(0); } }

        /* DONATION RANKING */
        .ranking-grid { display: flex; flex-direction: column; gap: 10px; }
        .rank-card { display: flex; align-items: center; padding: 10px; border-radius: 8px; background: var(--bg-card); border: 1px solid #333; position: relative; overflow: hidden; transition: transform 0.2s; }
        .rank-card:hover { transform: translateX(5px); }
        .rank-1 { border-color: #ffd700; background: linear-gradient(90deg, rgba(255, 215, 0, 0.1), transparent); }
        .rank-2 { border-color: #c0c0c0; background: linear-gradient(90deg, rgba(192, 192, 192, 0.1), transparent); }
        .rank-3 { border-color: #cd7f32; background: linear-gradient(90deg, rgba(205, 127, 50, 0.1), transparent); }
        
        .rank-badge { 
            width: 24px; height: 24px; border-radius: 50%; display: flex; align-items: center; justify-content: center; 
            font-weight: 800; font-size: 0.9rem; margin-right: 10px; color: #000; box-shadow: 0 0 10px rgba(0,0,0,0.5);
        }
        .rb-1 { background: #ffd700; box-shadow: 0 0 10px #ffd700; }
        .rb-2 { background: #c0c0c0; box-shadow: 0 0 10px #c0c0c0; }
        .rb-3 { background: #cd7f32; box-shadow: 0 0 10px #cd7f32; }

        /* MODAL */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); display: none; justify-content: center; align-items: center; z-index: 1000; }
        .modal-box { background: var(--bg-card); border: 1px solid var(--accent); padding: 20px; border-radius: 10px; width: 90%; max-width: 350px; text-align: center; animation: fadeInDown 0.3s; }
        .modal-title { font-size: 1.2rem; font-weight: bold; color: #fff; margin-bottom: 10px; }
        .modal-text { color: #ccc; margin-bottom: 20px; font-size: 0.9rem; }
        .modal-btns { display: flex; gap: 10px; justify-content: center; }
        .btn-confirm { background: var(--accent-green); color: #000; border: none; padding: 8px 20px; border-radius: 5px; font-weight: bold; cursor: pointer; }
        .btn-cancel { background: #333; color: #fff; border: none; padding: 8px 20px; border-radius: 5px; font-weight: bold; cursor: pointer; }

    </style>
</head>
<body>

    <div class="game-container">
        <!-- HEADER REMOVED (Managed by header-manager.js) -->

        <main>
            <!-- PARTİ HERO -->
            <div class="party-hero">
                <div class="party-logo-lg" id="pLogoContainer" style="overflow: hidden; padding: 0;">
                    <span id="pAbbr">MBP</span>
                </div>
                <div class="ph-name" id="pName">Milli Birlik Partisi</div>
                <div class="ph-leader" id="pLeader" style="font-size: 0.9rem; color: var(--accent-gold); margin-bottom: 5px; font-weight: 600;"></div>
                <div class="ph-ideology" id="pIdea">TEKNOKRAT</div>
                
                <div class="ph-stats">
                    <div class="phs-item">
                        <span class="phs-val" id="pMembers">1,420</span>
                        <span class="phs-lbl">ÜYE</span>
                    </div>
                    <div class="phs-item">
                        <span class="phs-val" id="pRank">#1</span>
                        <span class="phs-lbl">SIRALAMA</span>
                    </div>
                </div>
            </div>

            <!-- DUYURU -->
            <div class="notice-board" id="noticeBoard" style="display: none;">
                <div class="nb-title"><i class="fas fa-bullhorn"></i> BAŞKANIN MESAJI</div>
                <div class="nb-text" id="noticeText"></div>
                <div class="nb-date" id="noticeDate"></div>
            </div>

            <!-- SEKMELER -->
            <div class="tabs">
                <button class="tab-btn active" onclick="switchTab('members')">ÜYELER</button>
                <button class="tab-btn" onclick="switchTab('treasury')">PARTİ KASASI</button>
            </div>

            <!-- TAB 1: ÜYELER -->
            <div id="tab-members" class="content-section">
                <div id="totalMemberCount" style="color: #888; margin-bottom: 10px; font-size: 0.9rem; font-weight: bold;"></div>
                <div class="member-list" id="memberList">
                    <!-- JS Dolduracak -->
                </div>
                
                <button class="btn-leave" onclick="leaveParty()">PARTİDEN AYRIL</button>
            </div>

            <!-- TAB 2: KASA -->
            <div id="tab-treasury" class="content-section" style="display:none;">
                <div class="treasury-card">
                    <div style="font-size:0.8rem; color:#aaa; margin-bottom:5px;">TOPLAM VARLIK</div>
                    <div class="tr-val" id="partyVault">25.000.000 ₺</div>
                    <div class="tr-action">
                        <input type="number" id="donateAmount" class="modern-input" placeholder="Bağış Miktarı">
                    </div>
                    <button class="btn-donate" onclick="donateMoney()" style="margin-top:10px;">BAĞIŞ YAP (+İtibar)</button>
                </div>
                
                <!-- BAĞIŞ SIRALAMASI -->
                <div class="donation-ranking" style="margin-top:20px;">
                    <h4 style="color:var(--accent-gold); margin-bottom:10px; border-bottom:1px solid #333; padding-bottom:5px;">
                        <i class="fas fa-trophy"></i> EN ÇOK BAĞIŞ YAPANLAR
                    </h4>
                    <div id="donationRankingList" class="ranking-grid">
                        <!-- JS will fill this -->
                    </div>
                </div>

                <!-- Sadece Lider Görür -->
                <div class="donation-history" style="margin-top:20px;">
                    <h4 style="color:var(--accent-gold); margin-bottom:10px; border-bottom:1px solid #333; padding-bottom:5px;">
                        SON BAĞIŞLAR <span id="totalDonationCount" style="color:#666; font-size:0.8em; margin-left:5px;">(0)</span>
                    </h4>
                    <div id="donationList" style="display:flex; flex-direction:column; gap:10px;">
                        <!-- JS will fill this -->
                    </div>
                </div>
            </div>

        </main>

        <!-- BOTTOM NAV REMOVED (Managed by menu-manager.js) -->

    </div>

    <!-- CONFIRM MODAL -->
    <div class="modal-overlay" id="confirmModal">
        <div class="modal-box">
            <div class="modal-title">ONAYLA</div>
            <div class="modal-text" id="confirmText">İşlemi onaylıyor musunuz?</div>
            <div class="modal-btns">
                <button class="btn-cancel" onclick="closeModal()">İPTAL</button>
                <button class="btn-confirm" id="confirmBtn">ONAYLA</button>
            </div>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.js"></script>
    <script src="js/header-manager.js"></script>
    <script src="js/menu-manager.js"></script>
    <script>
        // Toastr Config
        toastr.options = {
            "closeButton": true,
            "progressBar": true,
            "positionClass": "toast-top-right",
            "timeOut": "3000"
        };

        let user = null;
        let partyId = null;
        let partyData = null;

        const fmt = (n) => n.toLocaleString('tr-TR');

        window.onload = async () => {
            const urlParams = new URLSearchParams(window.location.search);
            partyId = urlParams.get('id');

            if (!partyId) {
                alert("Parti ID bulunamadı!");
                window.location.href = 'politics-list.html';
                return;
            }

            const storedUser = localStorage.getItem('simWorldUser');
            if (!storedUser) {
                window.location.href = 'login.html';
                return;
            }
            user = JSON.parse(storedUser);

            await fetchUserStats();
            await fetchPartyDetails();
        };

        async function fetchUserStats() {
            try {
                const res = await fetch(`/api/user-stats/${user.id}`);
                if (res.ok) {
                    const data = await res.json();
                    user.money = data.money;
                    // Header manager handles display
                }
            } catch (e) { console.error(e); }
        }

        async function fetchPartyDetails() {
            try {
                const res = await fetch(`/api/parties/${partyId}?t=${new Date().getTime()}`);
                if (res.ok) {
                    const data = await res.json();
                    if (data.success) {
                        partyData = data.party;

                        // Access Check: Only members can view this page
                        const isMember = partyData.members && partyData.members.some(m => m.id == user.id);
                        if (!isMember) {
                            toastr.error("Bu sayfaya sadece parti üyeleri erişebilir!");
                            setTimeout(() => {
                                window.location.href = 'politics-list.html';
                            }, 1500);
                            return;
                        }

                        renderParty();
                    } else {
                        alert(data.message);
                        window.location.href = 'politics-list.html';
                    }
                } else {
                    alert("Parti verileri alınamadı.");
                }
            } catch (e) {
                console.error(e);
                alert("Sunucu hatası.");
            }
        }

        function renderParty() {
            // Hero Section
            document.getElementById('pName').innerText = partyData.name;
            
            // Leader Name
            const leader = partyData.members ? partyData.members.find(m => m.id === partyData.leader_id) : null;
            const leaderName = leader ? leader.username : 'Bilinmiyor';
            document.getElementById('pLeader').innerHTML = '<i class="fas fa-crown"></i> ' + leaderName;

            // Logo Handling
            const logoContainer = document.getElementById('pLogoContainer');
            if (partyData.logo && partyData.logo !== 'uploads/avatars/default.png') {
                logoContainer.innerHTML = `<img src="${partyData.logo}" style="width:100%; height:100%; object-fit:cover;">`;
            } else {
                logoContainer.innerHTML = `<span id="pAbbr">${partyData.abbr}</span>`;
            }

            document.getElementById('pIdea').innerText = partyData.ideology;
            document.getElementById('pMembers').innerText = partyData.members ? partyData.members.length : 0;
            document.getElementById('pRank').innerText = '#' + (partyData.rank || '-');
            
            // Color styling
            const pAbbrEl = document.getElementById('pLogoContainer');
            if (partyData.color) {
                pAbbrEl.style.color = partyData.color;
                pAbbrEl.style.borderColor = partyData.color;
                pAbbrEl.style.boxShadow = `0 0 15px ${partyData.color}40`;
            }

            // Vault
            document.getElementById('partyVault').innerText = fmt(partyData.vault || 0) + " ₺";

            // Announcement
            if (partyData.announcement) {
                document.getElementById('noticeBoard').style.display = 'block';
                document.getElementById('noticeText').innerText = partyData.announcement;
                const date = partyData.announcement_date ? new Date(partyData.announcement_date).toLocaleString('tr-TR') : '';
                document.getElementById('noticeDate').innerText = date;
            } else {
                document.getElementById('noticeBoard').style.display = 'none';
            }

            renderMembers();
            renderDonationRanking();
            renderDonationHistory();
        }

        function renderDonationRanking() {
            const container = document.getElementById('donationRankingList');
            container.innerHTML = '';
            
            if(!partyData.members) return;

            // Sort members by total_donated
            const sortedMembers = [...partyData.members]
                .filter(m => Number(m.total_donated) > 0)
                .sort((a, b) => Number(b.total_donated) - Number(a.total_donated))
                .slice(0, 3);
            
            if(sortedMembers.length === 0) {
                container.innerHTML = '<div style="text-align:center; color:#666; font-size:0.8rem;">Henüz veri yok.</div>';
                return;
            }

            sortedMembers.forEach((m, index) => {
                const rank = index + 1;
                let rankClass = '';
                let badgeClass = '';
                if(rank === 1) { rankClass = 'rank-1'; badgeClass = 'rb-1'; }
                else if(rank === 2) { rankClass = 'rank-2'; badgeClass = 'rb-2'; }
                else if(rank === 3) { rankClass = 'rank-3'; badgeClass = 'rb-3'; }

                let roleClass = '';
                if(m.role === 'Başkan') roleClass = 'role-leader';
                else if(m.role === 'Bakan') roleClass = 'role-minister';

                let avatarUrl = 'uploads/avatars/default.png';
                if (m.avatar && m.avatar !== 'uploads/avatars/default.png') {
                    avatarUrl = m.avatar;
                }

                const reputation = Math.floor(Number(m.total_donated || 0) / 5000);

                const div = document.createElement('div');
                div.className = `rank-card ${rankClass}`;
                div.style.flexDirection = 'column';
                div.style.alignItems = 'stretch';

                div.innerHTML = `
                    <div style="display: flex; align-items: center; margin-bottom: 5px;">
                        <div class="rank-badge ${badgeClass}" style="margin-right: 10px;">${rank}</div>
                        <img src="${avatarUrl}" style="width:35px; height:35px; border-radius:50%; margin-right:10px; border:1px solid #555; object-fit:cover;">
                        <div style="font-weight:bold; font-size:0.9rem; color:#fff;">
                            #${m.id} - ${m.username} <span style="color:#aaa; font-weight:normal;">(Lv.${m.level || 1})</span>
                            <span class="${roleClass}" style="font-size:0.7em; padding:1px 4px; margin-left:5px; border-radius:4px; background:#222; color:#aaa; text-transform:uppercase;">${m.role || 'Üye'}</span>
                        </div>
                    </div>
                    <div style="display: flex; justify-content: space-between; align-items: center; font-size: 0.8rem; padding-left: 45px;">
                        <div style="color: var(--accent-gold);">
                            <i class="fas fa-star"></i> İtibar: ${reputation}
                        </div>
                        <div style="font-weight:800; color:${rank === 1 ? '#ffd700' : (rank === 2 ? '#c0c0c0' : '#cd7f32')}">
                            ${fmt(m.total_donated)} ₺
                        </div>
                    </div>
                `;
                container.appendChild(div);
            });
        }

        function renderDonationHistory() {
            const container = document.getElementById('donationList');
            container.innerHTML = '';
            
            // Update Total Count
            document.getElementById('totalDonationCount').innerText = `(${fmt(partyData.totalDonations || 0)})`;

            if (!partyData.donationLogs || partyData.donationLogs.length === 0) {
                container.innerHTML = '<div style="text-align:center; color:#666; font-size:0.8rem;">Henüz bağış yapılmamış.</div>';
                return;
            }

            partyData.donationLogs.forEach(log => {
                let avatarUrl = 'uploads/avatars/default.png';
                if (log.avatar && log.avatar !== 'uploads/avatars/default.png') {
                    avatarUrl = log.avatar;
                }
                
                const reputation = Math.floor(log.amount / 5000);
                const dateStr = new Date(log.created_at).toLocaleString('tr-TR');
                
                let roleClass = '';
                if(log.role === 'Başkan') roleClass = 'role-leader';
                else if(log.role === 'Bakan') roleClass = 'role-minister';

                const item = document.createElement('div');
                item.className = 'member-card';
                item.style.padding = '8px';
                item.innerHTML = `
                    <div class="mc-left">
                        <img src="${avatarUrl}" class="mc-avatar" style="width:30px; height:30px;">
                        <div style="flex: 1;">
                            <div class="mc-name" style="font-size:0.9rem;">
                                #${log.user_id} - ${log.username} 
                                <span style="color:#aaa; font-weight:normal;">(Lv.${log.level || 1})</span>
                                <span class="mc-role ${roleClass}" style="font-size:0.65em; padding:1px 4px; margin-left:5px; vertical-align: middle;">${log.role || 'Üye'}</span>
                            </div>
                            <div style="display:flex; justify-content:space-between; align-items:center; margin-top:2px; font-size:0.75rem; color:#ccc;">
                                <span>
                                    <span style="color:var(--accent-green); font-weight:bold;">+${fmt(log.amount)} ₺</span> 
                                    <span style="color:var(--accent-gold); margin-left:5px;">(+${reputation} İtibar)</span>
                                </span>
                                <span style="font-size:0.7rem; color:#666;">${dateStr}</span>
                            </div>
                        </div>
                    </div>
                `;
                container.appendChild(item);
            });
        }

        function renderMembers() {
            const container = document.getElementById('memberList');
            container.innerHTML = '';

            const countEl = document.getElementById('totalMemberCount');
            if(countEl) countEl.innerText = `Toplam Üye Sayısı: ${partyData.members ? partyData.members.length : 0}`;

            if (!partyData.members) return;

            // Sort members by role
            partyData.members.sort((a, b) => {
                const score = (r) => {
                    if(r === 'Genel Başkan') return 1;
                    if(r === 'Başkan Yardımcısı') return 2;
                    if(r === 'Teşkilat Sorumlusu') return 3;
                    return 4;
                };
                return score(a.role) - score(b.role);
            });

            partyData.members.forEach(m => {
                let roleClass = 'role-member';
                if(m.role === 'Genel Başkan') roleClass = 'role-leader';
                else if(m.role === 'Başkan Yardımcısı') roleClass = 'role-vice';
                else if(m.role === 'Teşkilat Sorumlusu') roleClass = 'role-org';

                // Avatar handling
                let avatarUrl = 'uploads/avatars/default.png';
                if (m.avatar && m.avatar !== 'uploads/avatars/default.png') {
                    avatarUrl = m.avatar;
                }

                // Reputation Calculation (Her 5000 TL bağış = 1 İtibar)
                const reputation = Math.floor(Number(m.total_donated || 0) / 5000);

                const card = document.createElement('div');
                card.className = 'member-card';
                card.innerHTML = `
                    <div class="mc-left">
                        <img src="${avatarUrl}" class="mc-avatar" style="object-fit:cover;">
                        <div>
                            <div class="mc-name">
                                #${m.id} - ${m.username} 
                                <span style="color:#aaa; font-weight:normal;">(Lv.${m.level || 1})</span>
                                <span class="mc-role ${roleClass}" style="font-size:0.7em; padding:1px 4px; margin-left:5px; vertical-align: middle;">${m.role || 'Üye'}</span>
                            </div>
                            <div style="font-size: 0.75rem; color: var(--accent-gold); margin-top: 2px;">
                                <i class="fas fa-star" style="font-size:0.7rem;"></i> İtibar: ${reputation}
                            </div>
                        </div>
                    </div>
                    ${(user.id == partyData.leader_id && m.id != user.id) ? '<button class="btn-kick" onclick="kickMember('+m.id+')">AT</button>' : ''}
                `;
                container.appendChild(card);
            });
        }

        function switchTab(tab) {
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            if(event && event.target) event.target.classList.add('active');

            document.getElementById('tab-members').style.display = 'none';
            document.getElementById('tab-treasury').style.display = 'none';
            document.getElementById('tab-' + tab).style.display = 'block';
        }

        // --- İŞLEMLER ---
        let pendingDonation = 0;

        function donateMoney() {
            const amount = parseInt(document.getElementById('donateAmount').value);
            if(!amount || amount <= 0) return toastr.warning("Geçersiz miktar.");
            if(user.money < amount) return toastr.error("Yetersiz Bakiye!");

            pendingDonation = amount;
            showModal(`Partiye <b>${fmt(amount)} ₺</b> bağış yapmak istiyor musunuz?`, confirmDonation);
        }

        async function confirmDonation() {
            closeModal();
            try {
                const res = await fetch('/api/party/deposit', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ partyId: partyId, userId: user.id, amount: pendingDonation })
                });
                const data = await res.json();
                
                if(data.success) {
                    toastr.success(data.message || "Bağış başarıyla yapıldı.");
                    // Update UI
                    user.money -= pendingDonation;
                    if(document.getElementById('headerMoney')) {
                        document.getElementById('headerMoney').innerText = fmt(user.money) + " ₺";
                    }
                    partyData.vault += pendingDonation;
                    document.getElementById('partyVault').innerText = fmt(partyData.vault) + " ₺";
                    document.getElementById('donateAmount').value = '';
                    
                    // Listeyi güncellemek için verileri tekrar çek
                    await fetchPartyDetails();
                } else {
                    toastr.error(data.message);
                }
            } catch(e) {
                console.error(e);
                toastr.error("Sunucu hatası.");
            }
        }

        // Modal Functions
        function showModal(text, callback) {
            document.getElementById('confirmText').innerHTML = text;
            document.getElementById('confirmBtn').onclick = callback;
            document.getElementById('confirmModal').style.display = 'flex';
        }

        function closeModal() {
            document.getElementById('confirmModal').style.display = 'none';
        }

        function leaveParty() {
            if (partyData.leader_id == user.id) {
                toastr.error("Genel Başkan partiden ayrılamaz! Önce başkanlığı devretmelisiniz.");
                return;
            }
            showModal("Partiden ayrılmak istediğine emin misin?", confirmLeave);
        }

        async function confirmLeave() {
            closeModal();
            try {
                const res = await fetch('/api/party/leave', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ userId: user.id })
                });
                const data = await res.json();
                
                if(data.success) {
                    toastr.success(data.message);
                    setTimeout(() => {
                        window.location.href = 'politics-list.html';
                    }, 1500);
                } else {
                    toastr.error(data.message);
                }
            } catch(e) {
                console.error(e);
                toastr.error("Sunucu hatası.");
            }
        }

        function kickMember(memberId) {
             if(confirm("Bu üyeyi atmak istediğine emin misin?")) {
                // TODO: Implement API call for kicking
                alert("Üye atma sistemi henüz aktif değil.");
            }
        }

    </script>
</body>
</html>