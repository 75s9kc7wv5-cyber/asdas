<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sim of World - Hastane Sistemi</title>
    <link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@400;600;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.js"></script>
    
    <style>
        :root {
            --bg-dark: #0d0d0d;
            --bg-card: #161616;
            --accent-cyan: #00e5ff;
            --accent-green: #2ecc71;
            --accent-gold: #ffd700;
            --accent-red: #e74c3c;
            --accent-purple: #9b59b6;
            --text-white: #ffffff;
            --text-muted: #888;
            --border-color: #333;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            background-color: #000;
            font-family: 'Rajdhani', sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            color: var(--text-white);
        }

        .game-container {
            width: 100%;
            max-width: 450px;
            background-color: var(--bg-dark);
            height: 100vh;
            display: flex;
            flex-direction: column;
            position: relative;
            box-shadow: 0 0 30px rgba(0,0,0,0.5);
            background-image: linear-gradient(rgba(0,0,0,0.92), rgba(0,0,0,0.92)), url('https://upload.wikimedia.org/wikipedia/commons/thumb/e/ec/World_map_blank_without_borders.svg/2000px-World_map_blank_without_borders.svg.png');
            background-size: cover;
            background-position: center;
        }

        /* HEADER */
        header { background-color: #0a0a0a; padding: 10px; border-bottom: 1px solid var(--border-color); }
        .top-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .logo { font-size: 1.2rem; font-weight: 700; }
        .stat-box { background: #222; padding: 5px 10px; border-radius: 4px; font-size: 0.9rem; color: var(--accent-cyan); display: flex; align-items: center; gap: 5px; }
        .status-bars { display: flex; gap: 5px; }
        .bar-item { background: #222; padding: 4px; border-radius: 15px; font-size: 0.75rem; flex: 1; text-align: center; font-weight: bold; }

        /* MAIN */
        main {
            flex: 1;
            padding: 15px;
            overflow-y: auto;
            padding-bottom: 80px;
        }

        .page-header { text-align: center; margin-bottom: 20px; animation: fadeInDown 0.5s; }
        .page-title { font-size: 1.4rem; letter-spacing: 1px; color: #fff; text-transform: uppercase; font-weight: 800; }
        .page-desc { font-size: 0.8rem; color: var(--text-muted); }

        /* TABS */
        .tabs { display: flex; gap: 10px; margin-bottom: 20px; background: #111; padding: 5px; border-radius: 8px; border: 1px solid #333; }
        .tab-btn { flex: 1; padding: 10px; border: none; background: transparent; color: #777; font-family: 'Rajdhani'; font-weight: bold; cursor: pointer; border-radius: 6px; transition: all 0.3s; }
        .tab-btn.active { background: #222; color: var(--accent-cyan); border: 1px solid var(--accent-cyan); box-shadow: 0 0 10px rgba(0, 229, 255, 0.1); }

        /* --- BÖLÜM 1: ŞEHİR HASTANELERİ LİSTESİ --- */
        
        /* Filtreler */
        .filter-bar { display: flex; gap: 8px; margin-bottom: 15px; overflow-x: auto; padding-bottom: 5px; }
        .filter-btn { 
            background: #222; border: 1px solid #444; color: #aaa; padding: 6px 12px; 
            border-radius: 20px; font-family: 'Rajdhani'; cursor: pointer; white-space: nowrap; font-size: 0.8rem;
        }
        .filter-btn.active { background: var(--accent-cyan); color: #000; border-color: var(--accent-cyan); font-weight: bold; }

        .search-box {
            background: #222; border: 1px solid #444; border-radius: 8px; padding: 10px;
            display: flex; align-items: center; gap: 10px; margin-bottom: 15px;
        }
        .search-box input { background: transparent; border: none; color: #fff; width: 100%; font-family: 'Rajdhani'; outline: none; }

        /* Liste Grid */
        .city-grid { display: grid; grid-template-columns: 1fr; gap: 15px; }

        .city-card {
            background: rgba(30, 30, 30, 0.95);
            border: 1px solid var(--border-color);
            border-left: 3px solid var(--accent-red);
            border-radius: 8px;
            padding: 12px;
            display: flex;
            align-items: center;
            gap: 12px;
            position: relative;
            animation: fadeIn 0.5s ease;
        }
        
        /* Online Durumu */
        .owner-status {
            width: 10px; height: 10px; border-radius: 50%;
            position: absolute; top: 10px; right: 10px;
            box-shadow: 0 0 5px currentColor;
        }
        .status-online { background: var(--accent-green); color: var(--accent-green); }
        .status-offline { background: var(--accent-red); color: var(--accent-red); }

        .cc-icon { 
            width: 50px; height: 50px; background: #222; border-radius: 8px; 
            display: flex; align-items: center; justify-content: center; font-size: 1.5rem; color: var(--accent-red);
            border: 1px solid #333;
        }
        
        .cc-info { flex: 1; }
        .cc-title { font-size: 1rem; font-weight: bold; color: #fff; }
        .cc-owner { font-size: 0.75rem; color: var(--text-muted); margin-bottom: 5px; }
        
        .cc-details { display: flex; gap: 10px; font-size: 0.75rem; color: #ccc; margin-bottom: 8px; flex-wrap: wrap; }
        .cc-tag { background: #111; padding: 2px 5px; border-radius: 3px; }

        .cc-action { display: flex; align-items: center; justify-content: center; width: 100%; }
        
        .btn-visit {
            background: transparent; border: 1px solid var(--accent-cyan); color: var(--accent-cyan);
            padding: 12px; border-radius: 4px; cursor: pointer; font-family: 'Rajdhani'; font-weight: bold;
            transition: all 0.2s;
            width: 100%; text-align: center;
        }
        .btn-visit:hover { background: var(--accent-cyan); color: #000; }

        /* --- BÖLÜM 2: HASTANE SATIN ALMA KARTI --- */
        .buy-card {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 10px;
            overflow: hidden;
            margin-bottom: 20px;
            animation: fadeIn 0.5s;
        }
        
        .buy-image {
            width: 100%;
            height: 140px;
            background: url('https://img.freepik.com/free-photo/futuristic-hospital-building-night_23-2150967345.jpg') center/cover;
            position: relative;
        }
        .buy-level-badge {
            position: absolute; top: 10px; right: 10px;
            background: rgba(0,0,0,0.8); color: var(--accent-gold);
            padding: 4px 8px; border-radius: 4px; font-size: 0.8rem; font-weight: bold; border: 1px solid var(--accent-gold);
        }

        .buy-content { padding: 15px; }
        .buy-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .buy-title { font-size: 1.2rem; font-weight: bold; color: #fff; }
        
        .buy-stats { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px; }
        .bs-item { background: #111; padding: 8px; border-radius: 5px; font-size: 0.8rem; color: #aaa; border: 1px solid #333; }
        .bs-val { display: block; font-size: 1rem; color: #fff; font-weight: bold; margin-top: 2px; }
        
        .buy-price-row { display: flex; gap: 15px; margin-bottom: 15px; justify-content: center; background: #0a0a0a; padding: 10px; border-radius: 5px; }
        .bp-item { font-size: 1.1rem; font-weight: bold; display: flex; align-items: center; gap: 5px; }
        
        .btn-buy { 
            width: 100%; padding: 12px; border: none; border-radius: 5px; 
            background: linear-gradient(90deg, var(--accent-red), #c0392b); color: #fff;
            font-family: 'Rajdhani'; font-weight: bold; font-size: 1rem; cursor: pointer;
            box-shadow: 0 4px 15px rgba(231, 76, 60, 0.3);
        }
        .btn-buy:disabled { filter: grayscale(1); cursor: not-allowed; opacity: 0.7; }

        /* MODAL */
        .modal-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.95); z-index: 100;
            display: none; justify-content: center; align-items: center;
            animation: fadeIn 0.3s;
        }
        .modal-content {
            background: #181818; width: 85%; padding: 25px; border-radius: 10px;
            border: 1px solid #444; text-align: center; border-top: 3px solid var(--accent-cyan);
        }
        .m-btns { display: flex; gap: 10px; margin-top: 20px; }
        .m-btn { flex: 1; padding: 10px; border: none; border-radius: 5px; font-weight: bold; cursor: pointer; font-family: 'Rajdhani'; }

        /* Animasyonlar */
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes fadeInDown { from { opacity: 0; transform: translateY(-20px); } to { opacity: 1; transform: translateY(0); } }

    </style>
</head>
<body>

    <div class="game-container">
        <header>
            <div class="top-bar">
                <div class="logo">SIM <span>OF WORLD</span></div>
                <div class="stat-box"><img src="icons/inventory-icon/money.png" style="width:20px;height:20px;vertical-align:middle;"> <span id="userMoney">6.979.173</span></div>
            </div>
            <div class="status-bars">
                <div class="bar-item" style="color:#e74c3c;"><i class="fas fa-heart"></i> %100</div>
                <div class="bar-item" style="color:#f1c40f;"><i class="fas fa-hamburger"></i> %92</div>
                <div class="bar-item" style="color:#00e5ff;"><i class="fas fa-bolt"></i> %97</div>
                <div class="bar-item" style="color:#2ecc71;">VIP</div>
            </div>
        </header>

        <main>
            <div class="page-header">
                <h1 class="page-title">SAĞLIK SİSTEMİ</h1>
                <p class="page-desc">Tedavi ol veya kendi hastaneni yönet.</p>
            </div>

            <div class="tabs">
                <button class="tab-btn active" onclick="switchTab('list')">ŞEHİR HASTANELERİ</button>
                <button class="tab-btn" onclick="switchTab('buy')">HASTANEM</button>
            </div>

            <div id="tab-list">
                
                <div class="search-box">
                    <i class="fas fa-search" style="color:#666;"></i>
                    <input type="text" id="searchInput" placeholder="Hastane veya oyuncu adı ara..." onkeyup="filterHospitals()">
                </div>

                <div class="filter-bar">
                    <button class="filter-btn active" onclick="sortHospitals('price')">En Ucuz</button>
                    <button class="filter-btn" onclick="sortHospitals('quality')">En Kaliteli</button>
                    <button class="filter-btn" onclick="sortHospitals('capacity')">Boş Yatak</button>
                </div>

                <div class="city-grid" id="cityHospitalList">
                    </div>
            </div>

            <div id="tab-buy" style="display:none;">
                <div id="buySection">
                    <div class="buy-card">
                        <div class="buy-image">
                            <div class="buy-level-badge">HASTANE LİSANSI GEREKLİ</div>
                        </div>
                        <div class="buy-content">
                            <div class="buy-header">
                                <div class="buy-title">Özel Şehir Hastanesi</div>
                            </div>
                            
                            <div class="buy-stats">
                                <div class="bs-item">Kapasite <span class="bs-val">5 Yatak</span></div>
                                <div class="bs-item">Tedavi Hızı <span class="bs-val">10 Sn</span></div>
                                <div class="bs-item">Kalite <span class="bs-val">%100</span></div>
                                <div class="bs-item">Vergi <span class="bs-val">%10</span></div>
                            </div>

                            <div class="buy-price-row">
                                <div class="bp-item" style="color:var(--accent-green)">50.000 ₺ <span style="font-size:0.7rem; color:#aaa;">(+5.000 Vergi)</span></div>
                                <div class="bp-item" style="color:var(--accent-gold)">500 <img src="icons/inventory-icon/gold.png" style="width:16px;height:16px;vertical-align:middle;"></div>
                            </div>

                            <button class="btn-buy" onclick="openBuyModal()">SATIN AL VE İŞLETMEYE BAŞLA</button>
                        </div>
                    </div>
                </div>

                <div id="manageSection" style="display:none; text-align:center; padding:20px; border:1px solid #333; border-radius:10px; background:#111;">
                    <i class="fas fa-hospital-user" style="font-size:3rem; color:var(--accent-green); margin-bottom:10px;"></i>
                    <h3 id="myHospitalName">HASTANENİZ AKTİF</h3>
                    <p style="color:#aaa;">Kapasite: <span id="myHospitalCapacity">5</span> / Kalite: %<span id="myHospitalQuality">100</span></p>
                    <p style="color:var(--accent-gold); font-size:1.2rem; font-weight:bold; margin-top:10px;">Tedavi Ücreti: <span id="myHospitalPrice">100</span> ₺</p>
                    
                    <button class="btn-buy" onclick="window.location.href='hospital-management.html'" style="background:var(--accent-gold); color:#000; width:auto; padding:10px 20px; margin-top:15px;">
                        <i class="fas fa-cogs"></i> HASTANE YÖNET
                    </button>
                </div>
            </div>

        </main>

        <div class="modal-overlay" id="confirmBuyModal">
            <div class="modal-content">
                <i class="fas fa-hospital-alt" style="font-size:3rem; color:var(--accent-red); margin-bottom:10px;"></i>
                <h3 style="color:#fff; margin-bottom:10px;">Hastane Satın Al</h3>
                <p style="color:#aaa; font-size:0.9rem;">Bu işlem için hesabınızdan <strong>55.000 ₺</strong> (Vergi Dahil) ve <strong>500 Altın</strong> tahsil edilecektir.</p>
                <div class="m-btns">
                    <button class="m-btn" style="background:#333; color:#fff;" onclick="closeModal('confirmBuyModal')">İPTAL</button>
                    <button class="m-btn" style="background:var(--accent-green); color:#000;" onclick="completePurchase()">ONAYLA</button>
                </div>
            </div>
        </div>
        
        <div class="modal-overlay" id="treatmentModal">
            <div class="modal-content">
                <i class="fas fa-procedures" style="font-size:3rem; color:var(--accent-cyan); margin-bottom:10px;"></i>
                <h3 style="color:#fff; margin-bottom:5px;" id="tmName">Hastane Adı</h3>
                <p style="color:var(--accent-gold); font-weight:bold; font-size:1.2rem;" id="tmPrice">2.000 ₺</p>
                <p style="color:#aaa; font-size:0.8rem; margin:10px 0;">Tedavi Süresi: <span id="tmTime" style="color:#fff;">10 Sn</span></p>
                
                <div class="m-btns">
                    <button class="m-btn" style="background:#333; color:#fff;" onclick="closeModal('treatmentModal')">VAZGEÇ</button>
                    <button class="m-btn" style="background:var(--accent-cyan); color:#000;" onclick="startTreatment()">TEDAVİ OL</button>
                </div>
            </div>
        </div>

        <div id="menu-container"></div>

    </div>

    <script src="js/loader-manager.js"></script>
    <script src="js/menu-manager.js"></script>
    <script src="js/header-manager.js"></script>
    <script>
        let cityHospitals = [];
        let currentTreatmentId = null;
        let myHospital = null;

        // Format
        const fmt = (num) => num.toLocaleString('tr-TR');

        async function initPage() {
            await loadHospitals();
            await checkMyHospital();
        }

        async function loadHospitals() {
            try {
                const response = await fetch('/api/hospitals');
                cityHospitals = await response.json();
                renderCityHospitals(cityHospitals);
            } catch (error) {
                console.error('Hata:', error);
            }
        }

        async function checkMyHospital() {
            const user = JSON.parse(localStorage.getItem('simWorldUser'));
            if (!user) return;

            try {
                const response = await fetch(`/api/hospitals/my/${user.id}`);
                const result = await response.json();
                
                if (result.success && result.hasHospital) {
                    myHospital = result.hospital;
                    document.getElementById('buySection').style.display = 'none';
                    document.getElementById('manageSection').style.display = 'block';
                    
                    // Update Manage UI
                    document.getElementById('myHospitalName').innerText = myHospital.name;
                    document.getElementById('myHospitalCapacity').innerText = myHospital.capacity;
                    document.getElementById('myHospitalQuality').innerText = myHospital.quality;
                    document.getElementById('myHospitalPrice').innerText = myHospital.price;
                } else {
                    myHospital = null;
                    document.getElementById('buySection').style.display = 'block';
                    document.getElementById('manageSection').style.display = 'none';
                }
            } catch (error) {
                console.error('Hastane kontrol hatası:', error);
            }
        }

        function openBuyModal() {
            document.getElementById('confirmBuyModal').style.display = 'flex';
        }

        async function completePurchase() {
            const user = JSON.parse(localStorage.getItem('simWorldUser'));
            if (!user) return;

            try {
                const response = await fetch('/api/hospitals/buy', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ userId: user.id, name: 'Özel Şehir Hastanesi' })
                });
                const result = await response.json();

                if (result.success) {
                    toastr.success(result.message, 'Başarılı');
                    closeModal('confirmBuyModal');
                    await checkMyHospital();
                    if (window.updateHeader) window.updateHeader();
                } else {
                    toastr.error(result.message, 'Hata');
                    closeModal('confirmBuyModal');
                }
            } catch (error) {
                console.error(error);
                toastr.error('Sunucu hatası.', 'Hata');
            }
        }

        // --- ŞEHİR HASTANELERİ LİSTELEME ---
        function renderCityHospitals(data) {
            const container = document.getElementById('cityHospitalList');
            container.innerHTML = '';

            if (data.length === 0) {
                container.innerHTML = '<div style="text-align:center; padding:20px; color:#666;">Şehirde henüz hastane yok.</div>';
                return;
            }

            data.forEach(h => {
                const active = h.active_patients || 0;
                const capacity = h.capacity || 5;
                const isFull = active >= capacity;
                
                // Duration Calculation
                const duration = Math.max(3, 20 - (h.level - 1) * 2);

                const isOnline = Math.random() > 0.5; // Mock online status
                const statusClass = isOnline ? 'status-online' : 'status-offline';
                
                const card = document.createElement('div');
                card.className = 'city-card';
                card.innerHTML = `
                    <div class="owner-status ${statusClass}"></div>
                    <div class="cc-icon">
                        <i class="fas fa-hospital-symbol"></i>
                    </div>
                    <div class="cc-info">
                        <div class="cc-title">${h.name}</div>
                        <div class="cc-owner">Sahibi: <a href="profile.html?id=${h.owner_id}" style="color:var(--accent-cyan); text-decoration:none;">${h.owner_name}</a></div>
                        <div class="cc-details">
                            <span class="cc-tag"><i class="fas fa-heart" style="color:var(--accent-red)"></i> %100</span>
                            <span class="cc-tag"><i class="fas fa-clock"></i> ${duration} dk</span>
                            <span class="cc-tag" style="color:${isFull ? 'red' : '#aaa'}">
                                <i class="fas fa-bed"></i> ${active}/${capacity}
                            </span>
                            <span class="cc-tag" style="color:var(--accent-gold); font-weight:bold;">
                                ${fmt(h.price)} ₺
                            </span>
                        </div>
                        <div class="cc-action">
                            <button class="btn-visit" onclick="window.location.href='hospital-detail.html?id=${h.id}'">
                                HASTANEYE GİT
                            </button>
                        </div>
                    </div>
                `;
                container.appendChild(card);
            });
        }

        // --- FİLTRELEME VE ARAMA ---
        document.getElementById('searchInput').addEventListener('input', (e) => {
            const val = e.target.value.toLowerCase();
            const filtered = cityHospitals.filter(h => 
                h.name.toLowerCase().includes(val) || h.owner_name.toLowerCase().includes(val)
            );
            renderCityHospitals(filtered);
        });

        function sortHospitals(criteria) {
            document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
            event.target.classList.add('active');

            let sorted = [...cityHospitals];
            if (criteria === 'price') sorted.sort((a, b) => a.price - b.price);
            if (criteria === 'quality') sorted.sort((a, b) => b.quality - a.quality);
            if (criteria === 'capacity') sorted.sort((a, b) => b.capacity - a.capacity);
            
            renderCityHospitals(sorted);
        }

        // --- TEDAVİ İŞLEMLERİ ---
        function openTreatmentModal(name, price, time, id) {
            currentTreatmentId = id;
            document.getElementById('tmName').innerText = name;
            document.getElementById('tmPrice').innerText = fmt(price) + " ₺";
            document.getElementById('tmTime').innerText = time + " Saniye";
            document.getElementById('treatmentModal').style.display = 'flex';
        }

        async function startTreatment() {
            const user = JSON.parse(localStorage.getItem('simWorldUser'));
            if (!user) return alert('Giriş yapmalısınız.');

            try {
                const response = await fetch('/api/hospital/treat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ userId: user.id, hospitalId: currentTreatmentId })
                });
                const result = await response.json();
                
                if (result.success) {
                    alert(result.message);
                    closeModal('treatmentModal');
                    // Header update logic if available
                } else {
                    alert(result.message);
                }
            } catch (e) {
                console.error(e);
                alert('Hata oluştu.');
            }
        }

        function closeModal(id) {
            document.getElementById(id).style.display = 'none';
        }

        // --- SEKME YÖNETİMİ ---
        function switchTab(tab) {
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            event.target.classList.add('active');

            document.getElementById('tab-buy').style.display = 'none';
            document.getElementById('tab-list').style.display = 'none';
            
            document.getElementById('tab-' + tab).style.display = 'block';

            if (tab === 'buy') {
                checkMyHospital();
            }
        }

        window.addEventListener('load', initPage);
    </script>
</body>
</html>