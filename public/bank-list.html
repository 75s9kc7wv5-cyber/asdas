<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0, minimum-scale=1.0">
    <title>Sim of World - Bankalar</title>
    <link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@400;600;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.css">
    <script src="js/loader-manager.js"></script>
    <script src="js/zoom-prevention.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.js"></script>
    
    <style>
        :root {
            --bg-dark: #0d0d0d;
            --bg-card: #161616;
            --accent-cyan: #00e5ff;
            --accent-green: #2ecc71;
            --accent-gold: #ffd700;
            --accent-red: #e74c3c;
            --text-white: #ffffff;
            --text-muted: #888;
            --border-color: #333;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            background-color: #000;
            font-family: 'Rajdhani', sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            color: var(--text-white);
        }

        .game-container {
            width: 100%;
            max-width: 450px;
            background-color: var(--bg-dark);
            height: 100vh;
            display: flex;
            flex-direction: column;
            position: relative;
            box-shadow: 0 0 30px rgba(0,0,0,0.5);
            background-image: linear-gradient(rgba(0,0,0,0.92), rgba(0,0,0,0.92)), url('img/world-map.png');
            background-size: cover;
            background-position: center;
        }

        /* MAIN */
        main {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            padding-bottom: 80px;
        }

        .page-header { text-align: center; margin-bottom: 25px; animation: fadeInDown 0.5s; }
        .header-badge {
            display: inline-block;
            background: linear-gradient(180deg, rgba(30,30,30,0.9) 0%, rgba(10,10,10,0.95) 100%);
            border: 1px solid #333;
            border-top: 3px solid var(--accent-gold);
            padding: 15px 40px;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            position: relative;
        }
        .header-badge::after {
            content: ''; position: absolute; bottom: -5px; left: 50%; transform: translateX(-50%);
            width: 60%; height: 2px; background: radial-gradient(circle, var(--accent-gold) 0%, transparent 100%);
            opacity: 0.5;
        }
        .page-title { 
            font-size: 1.4rem; font-weight: 800; letter-spacing: 2px; color: #fff; margin-bottom: 5px; 
            text-transform: uppercase; display: flex; align-items: center; justify-content: center; gap: 10px;
            text-shadow: 0 0 15px rgba(255, 215, 0, 0.4);
        }
        .page-desc { font-size: 0.85rem; color: #999; font-weight: 500; }

        /* TABS */
        .tabs { display: flex; gap: 10px; margin-bottom: 20px; background: #111; padding: 5px; border-radius: 8px; border: 1px solid #333; }
        .tab-btn { flex: 1; padding: 10px; border: none; background: transparent; color: #777; font-family: 'Rajdhani'; font-weight: bold; cursor: pointer; border-radius: 6px; transition: all 0.3s; }
        .tab-btn.active { background: #222; color: var(--accent-gold); border: 1px solid var(--accent-gold); box-shadow: 0 0 10px rgba(255, 215, 0, 0.1); }
        .tab-content { display: none; animation: fadeIn 0.4s; }
        .tab-content.active { display: block; }

        /* SEARCH BOX */
        .search-box {
            background: #181818; border: 1px solid #333; border-radius: 8px; padding: 10px;
            display: flex; align-items: center; gap: 10px; margin-bottom: 15px;
        }
        .search-box input { background: transparent; border: none; color: #fff; width: 100%; font-family: 'Rajdhani'; outline: none; }

        /* BANK CARD (Adapted from Farm List Card) */
        .bank-card {
            background: rgba(30, 30, 30, 0.95);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 15px;
            transition: transform 0.2s;
        }
        .bank-card:hover { transform: translateY(-2px); border-color: #555; }
        
        .farm-list-card {
            display: flex;
            align-items: center;
            gap: 15px;
            background: rgba(30,30,30,0.95);
            border: 1px solid #333;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            cursor: pointer;
            transition: transform 0.2s, border-color 0.2s;
            position: relative;
            overflow: hidden;
            text-decoration: none;
            color: #fff;
        }
        .farm-list-card:hover {
            transform: translateY(-2px);
            border-color: #555;
            background: rgba(40,40,40,0.95);
        }
        .farm-list-card::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            height: 100%;
            width: 4px;
            background: var(--accent-red); 
        }

        .farm-list-card.city-card::before {
            background: var(--accent-red);
        }

        .farm-list-card.city-card.owned::before {
            background: var(--accent-green);
        }
        
        .farm-list-card.owned::before {
            background: var(--accent-green);
        }

        .farm-list-card.owned {
            /* border: 1px solid var(--accent-green);  <-- Removed per request */
            box-shadow: 0 0 15px rgba(46, 204, 113, 0.15);
        }

        .farm-list-card.city-card {
            flex-direction: column;
            align-items: stretch;
            padding: 0;
            gap: 0;
        }

        .city-card-top {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 15px;
            cursor: pointer;
        }

        .city-card-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
            padding: 8px 15px;
            background: rgba(0, 0, 0, 0.3);
            border-top: 1px solid #333;
            font-size: 0.85rem;
        }

        .owner-info {
            display: flex;
            align-items: center;
            gap: 9px;
            color: #ccc;
        }
        .owner-info img {
             width: 22px; height: 22px; border-radius: 50%; object-fit: cover; border: 1px solid #444;
        }

        .level-stars {
            display: flex;
            gap: 2px;
        }
        .level-stars i { font-size: 0.7rem; color: #444; }
        .level-stars i.active { color: var(--accent-gold); text-shadow: 0 0 5px rgba(255, 215, 0, 0.3); }

        .stat-badge {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            padding: 4px 8px;
            border-radius: 4px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid #444;
            font-size: 0.75rem;
            color: #ddd;
            margin-right: 5px;
        }
        .stat-badge i { color: #aaa; }

        .right-arrow {
            color: #444;
            font-size: 1.2rem;
            margin-left: auto;
            transition: color 0.2s;
        }
        .farm-list-card:hover .right-arrow {
            color: #fff;
        }

        .bank-content {
            display: flex;
            align-items: center;
            gap: 15px;
            width: 100%;
        }

        .bank-icon {
            width: 50px; height: 50px;
            background: #222;
            border-radius: 8px; /* Changed from 50% circle to rounded square to match farm list */
            display: flex; align-items: center; justify-content: center;
            font-size: 1.5rem;
            border: 1px solid #444;
            color: var(--accent-gold);
        }
        
        .bank-info { flex: 1; }
        .bank-name { font-size: 1.1rem; font-weight: bold; color: #fff; }
        .bank-desc { font-size: 0.8rem; color: #888; }
        .bank-stats { font-size: 0.9rem; margin-top: 5px; white-space: nowrap; overflow-x: auto; }

        .btn-action {
            width: 100%;
            padding: 8px 15px;
            border: none;
            border-radius: 5px;
            font-weight: bold;
            cursor: pointer;
            font-family: 'Rajdhani';
            font-size: 0.9rem;
            transition: 0.2s;
        }
        .btn-open { background: var(--accent-green); color: #000; }
        .btn-open:hover { box-shadow: 0 0 10px rgba(46, 204, 113, 0.4); }
        .btn-view { background: var(--accent-cyan); color: #000; }
        .btn-view:hover { box-shadow: 0 0 10px rgba(0, 229, 255, 0.4); }

        /* Geri Dön Butonu */
        .back-btn {
            width: 40px;
            height: 40px;
            background: #222;
            border: 1px solid #444;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--accent-gold);
            font-size: 1.2rem;
            cursor: pointer;
            transition: all 0.3s;
            flex-shrink: 0;
        }
        .back-btn:hover {
            background: #2a2a2a;
            border-color: var(--accent-gold);
            box-shadow: 0 0 10px rgba(255, 215, 0, 0.2);
        }

        /* BUY CARD */
        .buy-card {
            background: rgba(30, 30, 30, 0.95);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 15px;
            transition: transform 0.2s;
        }
        .buy-card:hover { transform: translateY(-2px); border-color: #555; }

        .req-list { 
            display: flex;
            flex-direction: column;
            gap: 0;
            margin: 15px 0;
            background: #1a1a1a;
            padding: 10px;
            border-radius: 8px;
        }
        .info-list-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 6px 0;
            transition: all 0.2s;
            border-bottom: 1px solid rgba(255,255,255,0.05);
            background: transparent; /* Reset from prev */
            border-radius: 0;        /* Reset from prev */
            border: none;            /* Reset from prev */
            border-bottom: 1px solid rgba(255,255,255,0.05); /* Restore bottom border */
            margin-bottom: 0;        /* Reset from prev */
        }
        .info-list-item:last-child {
            border-bottom: none;
        }
        .info-list-item:hover {
            opacity: 0.8;
        }
        .info-left {
            display: flex;
            align-items: center;
            gap: 0;
            flex: 1;
        }
        .info-left i {
            width: 28px;
            min-width: 28px;
            text-align: left;
            margin-right: 10px;
            font-size: 1rem;
        }
        .info-left img {
            width: 24px;
            height: 24px;
            min-width: 24px;
            margin-right: 10px;
        }
        .info-label {
            color: #aaa;
            font-size: 0.85rem;
            font-weight: 500;
        }
        .info-value {
            color: #fff;
            font-size: 0.85rem;
            font-weight: 700;
            text-align: right;
            margin-left: auto;
        }
        .upgrade-cost-status {
            width: 18px;
            height: 18px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.7rem;
            margin-left: 15px;
            flex-shrink: 0;
            transition: all 0.3s ease;
        }
        .upgrade-cost-status.ok {
            background: linear-gradient(135deg, rgba(46, 204, 113, 0.2), rgba(46, 204, 113, 0.1));
            color: var(--accent-green);
            box-shadow: 0 0 15px rgba(46, 204, 113, 0.3);
        }
        .upgrade-cost-status.fail {
            background: linear-gradient(135deg, rgba(231, 76, 60, 0.2), rgba(231, 76, 60, 0.1));
            color: var(--accent-red);
            box-shadow: 0 0 15px rgba(231, 76, 60, 0.3);
        }
        
        /* Removed old req-badge styles to avoid confusion */
        .btn-confirm:disabled { background: #444; color: #888; cursor: not-allowed; }

        .buy-icon {
            width: 50px; height: 50px;
            background: #222;
            border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            font-size: 1.5rem;
            border: 1px solid #444;
            color: var(--accent-gold);
        }
        
        .buy-info { flex: 1; }
        .buy-name { font-size: 1.1rem; font-weight: bold; color: #fff; }
        .buy-desc { font-size: 0.8rem; color: #888; }
        .buy-stats { font-size: 0.9rem; color: var(--accent-green); margin-top: 5px; }

        .btn-buy-action {
            padding: 8px 15px;
            border: none;
            border-radius: 5px;
            font-weight: bold;
            cursor: pointer;
            font-family: 'Rajdhani';
            font-size: 0.9rem;
            transition: 0.2s;
            background: var(--accent-gold); color: #000;
        }
        .btn-buy-action:hover { box-shadow: 0 0 10px rgba(255, 215, 0, 0.4); }

        /* MODAL */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 2000; display: none; align-items: center; justify-content: center; backdrop-filter: blur(3px); }
        .modal-content {
            background: #181818; width: 90%; max-width: 400px; padding: 25px; border-radius: 10px;
            border: 1px solid #444; text-align: center; border-top: 3px solid var(--accent-gold);
        }
        .m-input {
            width: 100%; padding: 10px; background: #222; border: 1px solid #444; color: #fff;
            border-radius: 5px; margin: 15px 0; font-family: 'Rajdhani';
        }
        .m-btns { display: flex; gap: 10px; margin-top: 20px; }
        .m-btn { flex: 1; padding: 12px; border: none; border-radius: 5px; font-weight: bold; cursor: pointer; font-family: 'Rajdhani'; }

        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes fadeInDown { from { opacity: 0; transform: translateY(-20px); } to { opacity: 1; transform: translateY(0); } }

    </style>
</head>
<body>

    <div class="game-container">
        <!-- Header injected by header-manager.js -->

        <div style="display: flex; align-items: center; gap: 15px; padding: 20px 20px 0 20px; margin-bottom: 20px;">
            <button class="back-btn" onclick="window.location.href='home.html'">
                <i class="fas fa-arrow-left"></i>
            </button>
            <div>
                <h1 style="font-size: 1.5rem; font-weight: bold; margin: 0; line-height: 1.2;">BANKALAR</h1>
                <p style="font-size: 0.9rem; color: #888; margin: 0;">Finans yönetimi</p>
            </div>
        </div>

        <main>

            <div class="tabs">
                <button class="tab-btn active" onclick="switchTab('city')">ŞEHİRDEKİ BANKALAR</button>
                <button class="tab-btn" onclick="switchTab('my')">BANKAM</button>
            </div>

            <!-- CITY BANKS TAB -->
            <div id="tab-city" class="tab-content active">
                <div class="search-box">
                    <i class="fas fa-search" style="color:#666;"></i>
                    <input type="text" id="searchInput" placeholder="Banka veya sahip adı ara..." onkeyup="filterBanks()">
                </div>

                <div id="cityBankList">
                    <!-- JS will populate -->
                </div>
            </div>

            <!-- MY BANK TAB -->
            <div id="tab-my" class="tab-content">
                <div id="myBankContent">
                    <!-- JS will populate -->
                </div>
            </div>

        </main>

        <!-- CREATE BANK MODAL -->
        <div class="modal-overlay" id="createBankModal">
            <div class="modal-content">
                <i class="fas fa-university" style="font-size:3rem; color:var(--accent-gold); margin-bottom:10px;"></i>
                <h3 style="color:#fff;">Banka Kur</h3>
                <p style="color:#aaa; font-size:0.9rem;">Kendi bankanı kurmak için gereksinimleri karşılamalısın.</p>
                
                <input type="text" id="newBankName" class="m-input" placeholder="Banka Adı Giriniz..." maxlength="20" style="margin:10px 0;">
                
                <div class="req-list" id="reqList">
                    <!-- Requirements here -->
                </div>

                <div class="m-btns">
                    <button class="m-btn" style="background:#333; color:#fff;" onclick="closeModal('createBankModal')">İPTAL</button>
                    <button class="m-btn btn-confirm" id="btnConfirmBuy" style="background:var(--accent-green); color:#000;" onclick="createBank()">SATIN AL</button>
                </div>
            </div>
        </div>

        <!-- Open Account Modal -->
        <div id="openAccountModal" class="modal-overlay" style="display:none;">
            <div class="modal-content">
                <h3 class="m-title" style="color:#fff; margin-bottom:10px;">HESAP AÇ</h3>
                <p style="color:#aaa; font-size:0.9rem; margin-bottom:10px;">
                    <span id="openAccBankName" style="color:var(--accent-cyan); font-weight:bold;"></span> bankasında hesap açmak üzeresiniz.
                </p>
                <p style="color:var(--accent-gold); font-weight:bold; margin-bottom:20px;">
                    Hesap Açılış Ücreti: <span id="openAccFee">0</span> ₺
                </p>
                <div class="m-btns">
                    <button class="m-btn" style="background:#333; color:#fff;" onclick="closeModal('openAccountModal')">İPTAL</button>
                    <button class="m-btn" style="background:var(--accent-green); color:#fff;" onclick="confirmOpenAccount()">ONAYLA</button>
                </div>
            </div>
        </div>

        <!-- Confirm Create Bank Modal -->
        <div id="confirmCreateBankModal" class="modal-overlay" style="display:none;">
            <div class="modal-content">
                <i class="fas fa-university" style="font-size:3rem; color:var(--accent-gold); margin-bottom:15px;"></i>
                <h3 style="color:#fff; margin-bottom:10px;">Banka Satın Alma Onayı</h3>
                <p style="color:#aaa; font-size:0.9rem; margin-bottom:10px;">
                    <span id="confirmBankName" style="color:var(--accent-gold); font-weight:bold; font-size:1.1rem;"></span> adlı bankayı satın almak üzeresiniz.
                </p>
                <div style="background:#222; padding:15px; border-radius:8px; margin:15px 0;">
                    <p style="color:#ccc; font-size:0.9rem; margin-bottom:10px;"><strong>Harcanacak Kaynaklar:</strong></p>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">
                        <div class="req-badge" style="border-color: var(--accent-gold); color: var(--accent-gold); background: rgba(255, 215, 0, 0.1);">
                            <img src="icons/inventory-icon/money.png" style="width:16px; height:16px;">
                            <span>100.000</span>
                        </div>
                        <div class="req-badge" style="border-color: var(--accent-gold); color: var(--accent-gold); background: rgba(255, 215, 0, 0.1);">
                            <img src="icons/inventory-icon/gold.png" style="width:16px; height:16px;">
                            <span>500</span>
                        </div>
                        <div class="req-badge" style="border-color: var(--accent-gold); color: var(--accent-gold); background: rgba(255, 215, 0, 0.1);">
                            <img src="icons/inventory-icon/diamond.png" style="width:16px; height:16px;">
                            <span>50</span>
                        </div>
                    </div>
                </div>
                <p style="color:#e74c3c; font-size:0.85rem; margin-top:10px;">
                    ⚠️ Bu işlem geri alınamaz!
                </p>
                <div class="m-btns">
                    <button class="m-btn" style="background:#333; color:#fff;" onclick="closeModal('confirmCreateBankModal')">İPTAL</button>
                    <button class="m-btn" style="background:var(--accent-gold); color:#000;" onclick="confirmCreateBank()">ONAYLA VE SATIN AL</button>
                </div>
            </div>
        </div>

        <!-- Success Modal -->
        <div class="modal-overlay" id="successModal">
            <div class="modal-content" style="border-top: 3px solid var(--accent-green);">
                <i class="fas fa-check-circle" style="font-size:3rem; color:var(--accent-green); margin-bottom:10px;"></i>
                <h3 style="color:#fff;">İŞLEM BAŞARILI</h3>
                <p id="successMessage" style="color:#aaa; font-size:0.9rem; margin-bottom:20px;">İşleminiz başarıyla gerçekleştirildi.</p>
                <button class="m-btn" style="background:var(--accent-green); color:#000;" onclick="closeModal('successModal')">TAMAM</button>
            </div>
        </div>

        <!-- Failure Modal -->
        <div class="modal-overlay" id="failureModal">
            <div class="modal-content" style="border-top: 3px solid var(--accent-red);">
                <i class="fas fa-times-circle" style="font-size:3rem; color:var(--accent-red); margin-bottom:10px;"></i>
                <h3 style="color:#fff;">İŞLEM BAŞARISIZ</h3>
                <p id="failureMessage" style="color:#aaa; font-size:0.9rem; margin-bottom:20px;">Bir sorun oluştu.</p>
                <button class="m-btn" style="background:#333; color:#fff;" onclick="closeModal('failureModal')">KAPAT</button>
            </div>
        </div>
    </div>

    <script src="js/menu-manager.js"></script>
    <script src="js/header-manager.js"></script>
    <script>
        const eduStages = [
            { min: 1, max: 10, name: 'İlkokul' },
            { min: 11, max: 20, name: 'Ortaokul' },
            { min: 21, max: 30, name: 'Lise' },
            { min: 31, max: 40, name: 'Önlisans' },
            { min: 41, max: 50, name: 'Lisans' },
            { min: 51, max: 60, name: 'Yüksek Lisans' },
            { min: 61, max: 70, name: 'Doktora' },
            { min: 71, max: 80, name: 'Post-Doc' },
            { min: 81, max: 90, name: 'Doçentlik' },
            { min: 91, max: 100, name: 'Profesörlük' }
        ];

        const getEducationName = (skill) => {
            const stage = eduStages.find(s => skill >= s.min && skill <= s.max);
            return stage ? stage.name : 'Yok';
        };

        const fmt = (num) => num.toLocaleString('tr-TR');
        let allBanks = [];

        async function initPage() {
            await loadCityBanks();
            await loadMyBank();
        }

        let userHasAccount = false;

        async function loadCityBanks() {
            try {
                const user = JSON.parse(localStorage.getItem('simWorldUser'));
                const response = await fetch('/api/banks?userId=' + (user ? user.id : 0));
                allBanks = await response.json();
                
                // Check if user has any account
                userHasAccount = allBanks.some(b => b.has_account > 0);
                
                renderBanks(allBanks);
            } catch (error) {
                console.error(error);
            }
        }

        function renderBanks(banks) {
            const container = document.getElementById('cityBankList');
            container.innerHTML = '';
            
            const user = JSON.parse(localStorage.getItem('simWorldUser'));
            const userId = user ? user.id : 0;

            // Sort: 1. User's OWN bank, 2. Banks with accounts
            banks.sort((a, b) => {
                const aIsMyBank = a.owner_id === userId ? 1 : 0;
                const bIsMyBank = b.owner_id === userId ? 1 : 0;
                if (aIsMyBank !== bIsMyBank) return bIsMyBank - aIsMyBank;

                const aHasAccount = a.has_account > 0 ? 1 : 0;
                const bHasAccount = b.has_account > 0 ? 1 : 0;
                return bHasAccount - aHasAccount;
            });

            if (banks.length === 0) {
                container.innerHTML = '<div style="text-align:center; color:#666; margin-top:20px;">Şehirde henüz banka yok.</div>';
                return;
            }

            banks.forEach(b => {
                const hasAccount = b.has_account > 0;
                const isMyBank = b.owner_id === userId;
                let clickAction = '';
                
                if (isMyBank) {
                     clickAction = `openAccountPage(${b.id})`;
                } else if (hasAccount) {
                    clickAction = `openAccountPage(${b.id})`;
                } else if (userHasAccount) {
                    // User has account in another bank
                    clickAction = `toastr.warning('Zaten bir banka hesabiniz var. Sadece 1 hesap acabilirsiniz.')`;
                } else {
                    clickAction = `openOpenAccountModal(${b.id}, '${b.name}', ${b.account_opening_fee || 0})`;
                }

                // Owner Avatar logic
                let avatarSrc = 'uploads/avatars/default.png';
                if (b.owner_avatar) {
                     if (b.owner_avatar.includes('uploads/')) {
                        avatarSrc = b.owner_avatar.startsWith('/') ? b.owner_avatar : '/' + b.owner_avatar;
                    } else {
                        avatarSrc = '/uploads/avatars/' + b.owner_avatar;
                    }
                }
                
                const level = b.level || 1;

                const card = document.createElement('div');
                // Add 'owned' class if it is the user's bank OR if they have an account (for green border)
                // However, user specifically asked for "oyuncunun bankası varsa... yeşil olsun". 
                // Existing logic used 'owned' for hasAccount. Let's start by applying it for isMyBank too.
                card.className = `farm-list-card city-card ${hasAccount || isMyBank ? 'owned' : ''}`;
                
                // Top part with onclick action
                card.innerHTML = `
                    <div class="city-card-top" onclick="${clickAction}">
                        <div class="bank-icon">
                            <i class="fas fa-university" style="font-size: 1.5rem; color: var(--accent-gold);"></i>
                        </div>
                        <div class="bank-info">
                            <div class="bank-name">${b.name}</div>
                            <div class="bank-stats">
                                <span class="stat-badge" title="Müşteri Kapasitesi"><i class="fas fa-users" style="color: var(--accent-cyan);"></i> ${b.customer_count || 0}/${b.capacity || 0}</span>
                                <span class="stat-badge" title="Mevduat Faizi"><i class="fas fa-percent" style="color: var(--accent-green);"></i> %${b.interest_rate}</span>
                                <span class="stat-badge" title="Kredi Faizi"><i class="fas fa-hand-holding-usd" style="color: var(--accent-red);"></i> %${b.loan_rate}</span>
                                <span class="stat-badge" title="Hesap Açılış Ücreti"><i class="fas fa-coins" style="color: var(--accent-gold);"></i> ${fmt(b.account_opening_fee || 0)} ₺</span>
                            </div>
                        </div>
                        <i class="fas fa-chevron-right right-arrow"></i>
                    </div>
                    <div class="city-card-footer">
                        <div class="owner-info" onclick="location.href='profile.html?id=${b.owner_id}'; event.stopPropagation();" style="cursor:pointer;">
                            <img src="${avatarSrc}" alt="${b.owner_name}" onerror="this.src='https://ui-avatars.com/api/?name=${b.owner_name}&background=random'">
                            <span>${b.owner_id} - ${b.owner_name}</span>
                        </div>
                        <div class="level-stars">
                            ${Array(10).fill(0).map((_, i) => `<i class="fas fa-star ${i < level ? 'active' : ''}"></i>`).join('')}
                        </div>
                    </div>
                `;
                container.appendChild(card);
            });
        }

        function filterBanks() {
            const query = document.getElementById('searchInput').value.toLowerCase();
            const filtered = allBanks.filter(b => 
                b.name.toLowerCase().includes(query) || 
                b.owner_name.toLowerCase().includes(query)
            );
            renderBanks(filtered);
        }

        async function loadMyBank() {
            const user = JSON.parse(localStorage.getItem('simWorldUser'));
            if (!user) return;

            try {
                const response = await fetch(`/api/banks/my/${user.id}`);
                const result = await response.json();
                const container = document.getElementById('myBankContent');

                if (result.success && result.hasBank) {
                    const b = result.bank;
                    container.innerHTML = `
                        <div class="farm-list-card owned" onclick="window.location.href='bank-management.html'" style="display:flex;">
                            <div class="bank-icon" style="width: 50px; height: 50px; background: #222; border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 1.5rem; border: 1px solid #444; color: var(--accent-green);">
                                <img src="icons/bank-icon/bank.png" style="width:32px; height:32px; object-fit:contain;">
                            </div>
                            <div class="bank-info" style="flex:1;">
                                <div class="bank-name" style="font-size: 1.1rem; font-weight: bold; color: #fff;">${b.name}</div>
                                <div class="bank-desc" style="font-size: 0.8rem; color: #888;">Yönetim Paneli</div>
                            </div>
                            <i class="fas fa-chevron-right right-arrow"></i>
                        </div>
                    `;
                } else {
                    container.innerHTML = `
                        <div class="farm-list-card" onclick="openCreateBankModal()" style="display:flex;">
                            <div class="bank-icon" style="width: 50px; height: 50px; background: #222; border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 1.5rem; border: 1px solid #444; color: #666;">
                                <img src="icons/bank-icon/bank.png" style="width:32px; height:32px; object-fit:contain; filter: grayscale(100%);">
                            </div>
                            <div class="bank-info" style="flex:1;">
                                <div class="bank-name" style="font-size: 1.1rem; font-weight: bold; color: #fff;">Banka İşletmesi</div>
                                <div class="bank-desc" style="font-size: 0.8rem; color: #888;">Banka satın alıp gelir elde edebilirsiniz</div>
                            </div>
                            <i class="fas fa-chevron-right right-arrow"></i>
                        </div>
                    `;
                }
            } catch (error) {
                console.error(error);
            }
        }

        let selectedBankId = null;

        function openOpenAccountModal(bankId, bankName, fee) {
            selectedBankId = bankId;
            document.getElementById('openAccBankName').innerText = bankName;
            document.getElementById('openAccFee').innerText = fmt(fee);
            document.getElementById('openAccountModal').style.display = 'flex';
        }

        async function confirmOpenAccount() {
            if (!selectedBankId) return;
            const btn = document.querySelector('#openAccountModal .m-btn:last-child');
            btn.disabled = true;
            btn.innerText = 'İŞLENİYOR...';

            const user = JSON.parse(localStorage.getItem('simWorldUser'));
            
            try {
                const response = await fetch('/api/bank-accounts/open', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ userId: user.id, bankId: selectedBankId })
                });
                
                let result;
                try {
                    result = await response.json();
                } catch (e) {
                    throw new Error('Sunucu hatası: ' + response.status);
                }
                
                closeModal('openAccountModal');

                if (result.success) {
                    document.getElementById('successMessage').innerText = result.message;
                    document.getElementById('successModal').style.display = 'flex';
                    
                    await loadCityBanks();
                    // Refetch user money (header update usually handles it via event or explicit call)
                    if (window.updateHeaderStats) window.updateHeaderStats();
                } else {
                    document.getElementById('failureMessage').innerText = result.message || 'Bilinmeyen hata';
                    document.getElementById('failureModal').style.display = 'flex';
                }
            } catch (error) {
                console.error('Error:', error);
                closeModal('openAccountModal');
                document.getElementById('failureMessage').innerText = 'Bir hata oluştu: ' + error.message;
                document.getElementById('failureModal').style.display = 'flex';
            } finally {
                btn.disabled = false;
                btn.innerText = 'ONAYLA';
            }
        }

        function openAccountPage(bankId) {
            window.location.href = `bank-account-detail.html?bank_id=${bankId}`;
        }

        async function openCreateBankModal() {
            const user = JSON.parse(localStorage.getItem('simWorldUser'));
            if (!user) {
                toastr.error('Oturum bulunamadı. Lütfen giriş yapın.');
                return;
            }
            
            try {
                // Fetch user data and licenses
                const userResponse = await fetch(`/api/user-stats/${user.id}`);
                if (!userResponse.ok) {
                    throw new Error('Kullanıcı bilgileri alınamadı');
                }
                const userData = await userResponse.json();
                
                const licensesResponse = await fetch(`/api/licenses/${user.id}`);
                let licenses = {};
                if (licensesResponse.ok) {
                    licenses = await licensesResponse.json();
                }
                
                const hasLicense = (level) => {
                    const bankLicense = licenses['bank'] || licenses['bank_license'] || 0;
                    return bankLicense >= level;
                };
                
                let canBuy = true;
                
                const reqs = [
                    { label: 'Para', val: 100000, userVal: userData.money || 0, type: 'money' },
                    { label: 'Altın', val: 500, userVal: userData.gold || 0, type: 'gold' },
                    { label: 'Elmas', val: 50, userVal: userData.diamond || 0, type: 'diamond' },
                    { label: '1. Seviye Banka Lisansı', val: 1, userVal: hasLicense(1) ? 1 : 0, type: 'license' }
                ];
                
                let reqHTML = '';
                reqs.forEach(r => {
                    const isOk = r.userVal >= r.val;
                    if (!isOk) canBuy = false;
                    
                    let valDisplay;
                    if (r.type === 'license') {
                        valDisplay = r.val > 0 ? 'Var' : 'Yok';
                    } else if (r.type === 'education') {
                        valDisplay = getEducationName(r.val);
                    } else {
                        valDisplay = fmt(r.val);
                    }
                    
                    let iconHTML = '';
                    if (r.type === 'money') {
                        iconHTML = '<img src="icons/inventory-icon/money.png">';
                    } else if (r.type === 'gold') {
                        iconHTML = '<img src="icons/inventory-icon/gold.png">';
                    } else if (r.type === 'diamond') {
                        iconHTML = '<img src="icons/inventory-icon/diamond.png">';
                    } else if (r.type === 'education') {
                        iconHTML = '<i class="fas fa-graduation-cap" style="color:#aaa;"></i>';
                    } else {
                        iconHTML = '<i class="fas fa-certificate" style="color:#aaa;"></i>';
                    }
                    
                    const statusIcon = `
                        <div class="upgrade-cost-status ${isOk ? 'ok' : 'fail'}">
                            <i class="fas ${isOk ? 'fa-check' : 'fa-times'}"></i>
                        </div>`;
                    
                    const valColor = isOk ? 'var(--accent-green)' : 'var(--accent-red)';
                    
                    reqHTML += `
                        <div class="info-list-item">
                            <div class="info-left">
                                ${iconHTML}
                                <span class="info-label">${r.label}</span>
                            </div>
                            <span class="info-value" style="color:${valColor}">${valDisplay}</span>
                            ${statusIcon}
                        </div>
                    `;
                });
                
                // Populate Modal Content
                document.getElementById('reqList').innerHTML = reqHTML;
                document.getElementById('newBankName').value = ''; // Reset input
                
                const createBtn = document.querySelector('#createBankModal .m-btns button:last-child');
                if (createBtn) {
                     // Check if there is a create button and update it (if it was static, now it might need to rely on the template if I changed it)
                     // But wait, the modal static HTML is defined earlier, I can just update the button's disabled state or recreate it.
                     const modalFooter = document.querySelector('#createBankModal .m-btns');
                     const btnStyle = !canBuy ? 'background:#444; color:#888; cursor:not-allowed;' : 'background:var(--accent-green); color:#000;';
                     modalFooter.innerHTML = `
                        <button class="m-btn" style="background:#333; color:#fff;" onclick="closeModal('createBankModal')">İPTAL</button>
                        <button class="m-btn" style="${btnStyle}" 
                            onclick="createBank()" ${!canBuy ? 'disabled' : ''}>
                            SATIN AL
                        </button>
                     `;
                }

                document.getElementById('createBankModal').style.display = 'flex';
                
            } catch (error) {
                console.error('Form yükleme hatası:', error);
                toastr.error('Bilgiler yüklenirken hata oluştu: ' + error.message);
            }
        }

        function closeModal(id) {
            document.getElementById(id).style.display = 'none';
        }

        async function createBank() {
            const name = document.getElementById('newBankName').value.trim();
            
            if (!name) return toastr.warning('Banka adı giriniz.');
            if (name.length < 5) return toastr.warning('Banka adı en az 5 karakter olmalıdır.');
            if (name.length > 20) return toastr.warning('Banka adı en fazla 20 karakter olabilir.');

            const user = JSON.parse(localStorage.getItem('simWorldUser'));
            
            const modalFooter = document.querySelector('#createBankModal .m-btns');
            const btn = modalFooter.querySelector('button:last-child');
            const originalText = btn.innerText;
            btn.disabled = true;
            btn.innerText = 'SATIN ALINIYOR...';

            try {
                const response = await fetch('/api/banks/create', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ userId: user.id, name: name })
                });
                const result = await response.json();

                if (result.success) {
                    closeModal('createBankModal');
                    // Show success modal
                    document.getElementById('successMessage').innerText = result.message || 'Banka başarıyla kuruldu!';
                    document.getElementById('successModal').style.display = 'flex';
                    
                    await loadMyBank();
                    await loadCityBanks();
                    if (window.updateHeaderStats) window.updateHeaderStats();
                } else {
                    // Show failure modal
                    document.getElementById('failureMessage').innerText = result.message || 'Banka kurulamadı.';
                    document.getElementById('failureModal').style.display = 'flex';
                    btn.disabled = false;
                    btn.innerText = originalText;
                }
            } catch (error) {
                console.error(error);
                document.getElementById('failureMessage').innerText = 'Sunucuyla iletişim kurulurken bir hata oluştu.';
                document.getElementById('failureModal').style.display = 'flex';
                btn.disabled = false;
                btn.innerText = originalText;
            }
        }


        function switchTab(tab) {
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            event.target.classList.add('active');

            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            document.getElementById('tab-' + tab).classList.add('active');
        }

        window.addEventListener('load', initPage);
    </script>
</body>
</html>